{% extends "base.html" %}
{% load staticfiles %}
{% block content %}
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
  <h1 class="page-header">Cargar imagen</h1>
  <br>

<!--..................................................canvas ..................................................................  -->
  <!-- <div align="center">
    <input name="btnCargar" id="btnCargar" type="file" />
    <button type="button" name="button" onclick="pantalla()">ok</button>
    <img style="display:none" id="my_image">
  </div> -->
  <img src="../static/img/A_0482_1.LEFT_CC.LJPEG.1_highpass.gif" style="display:none" id="imgp">
  <div align="center">
    <canvas id="canvas" width="1200" height="500" style="display:none"></canvas>
  </div>
<!--..................................................canvas ..................................................................  -->
<br>

  <h2 class="sub-header">Areas seleccionadas</h2>
  <div class="table-responsive">
    <table class="table table-striped" id="tablaR">
      <thead>
        <tr>
          <th>#</th>
          <th>Posicion en X</th>
          <th>Posicion en Y</th>
          <th>Ancho</th>
          <th>Alto</th>
        </tr>
      </thead>
      <tbody>

      </tbody>
    </table>
    <div align="center">
      <button class="btn btn-primary" type="button" name="button">Enviar</button>
    </div>

  </div>
</div>

{% endblock content %}

{% block jscrpt %}
<script type="text/javascript">

// function pantalla(){
//       alert($('input[type=file]').val());
//       $("#my_image").attr("src",$('input[type=file]').val());
// }


var conrec=0;
var recuadros=new Array();
var recuadro;
var miLienzo; // el canvas
var contexto; // el contexto
var canvasLimites; // los margenes del canvas
var paint=false; // nos dice si pintar o no
var mbegin; // info de mi cuadro (x,y)
var mend; // info de mi cuadro (width,height)

function leerarray(){
      var recc=recuadros[recuadros.length-1];
      // alert("*"+recc[0]+" | "+recc[1]+" | "+recc[2]+" | "+recc[3]+" | "+recc[4]);
      $('#tablaR tr:last').after(
              '<tr>'
              +'<td>'+recc[0]+'</td>'
              +'<td>'+recc[1]+'</td>'
              +'<td>'+recc[2]+'</td>'
              +'<td>'+recc[3]+'</td>'
              +'<td>'+recc[4]+'</td>'
              +'</tr>');
}
function prepareCanvas(){
  miLienzo=document.getElementById("canvas");

  //tamanio del lienzo
  // alert(document.getElementById("imgp").width+" x "+document.getElementById("imgp").height);
  miLienzo.width=document.getElementById("imgp").width;
  miLienzo.height=document.getElementById("imgp").height;
  miLienzo.style="border:1px solid;background: url(../static/img/A_0482_1.LEFT_CC.LJPEG.1_highpass.gif) no-repeat;";

  contexto= miLienzo.getContext("2d"); // obtenemos el contexto ( dibujar en 2d)
  canvasLimites=miLienzo.getBoundingClientRect(); // obtenemos los limites del canvas
  miLienzo.addEventListener('mousedown',down,false);
  miLienzo.addEventListener('mouseup',up,false);
  miLienzo.addEventListener('mousemove',pintarCuadro,false);
  miLienzo.style.cursor="pointer";
}

function down(e) {
  mbegin=obtenerCoordenadas(e);
  paint= true;
}

function up(e) {
  paint= false;
  mend=obtenerBounds(e);
  recuadro.push(mend.w);
  recuadro.push(mend.h);
  recuadros.push(recuadro);
  leerarray();

}

function pintarCuadro(e) {
  if(paint){
    mend=obtenerBounds(e);
    contexto.clearRect(0,0,miLienzo.width,miLienzo.height);
    dibujarCuadro();
  }
}

function obtenerCoordenadas(event){
  var posX;
  var posY;

  if (event.pageX || event.pageY) {
    posX = event.pageX- canvasLimites.left;
    posY = event.pageY- canvasLimites.top;

    conrec+=1;
    recuadro=new Array();
    recuadro.push(conrec);
    recuadro.push(posX);
    recuadro.push(posY);
  }
  else {
    posX = event.clientX - canvasLimites.left;
    posY = event.clientY - canvasLimites.top;
  }

  return {
    x:posX,
    y:posY
  };
}

function obtenerBounds(event){
  var width;
  var height;

  if (event.pageX || event.pageY) {
    width= (event.pageX- canvasLimites.left)-mbegin.x;
    height= (event.pageY- canvasLimites.top)-mbegin.y;
    // if (contam==0) {
    //   contam=1;
    //   recuadro.push(width+"|"+height);
    //   recuadros.push(recuadro);
    // }
  }
  else {
    width= (event.clientX - canvasLimites.left)-mbegin.x;
    height= (event.clientY - canvasLimites.top)-mbegin.y;
  }

  return {
    w:width,
    h:height
  };
}

function dibujarCuadro(){
  contexto.fillStyle="rgba(22,87,122,0.7)";
  contexto.fillRect(mbegin.x, mbegin.y,mend.w,mend.h);
}
prepareCanvas();
</script>
{% endblock jscrpt %}
